# План объединённой базы данных для Katindirnet и Shorty

Этот документ описывает, как может быть организована единая SQLite‑база данных для двух проектов
— **Katindirnet** (креативное агентство с мемами, CV‑генератором и инструментами) и **Shorty**
— сервиса сокращения ссылок.  Цель — хранить все данные в одной базе, упростить
администрирование и предоставить единый механизм аутентификации и ролей для всех
подсистем.

## Общие принципы

1. **Одна таблица пользователей**.  Все аккаунты хранятся в таблице `users` с
   полями `id`, `email`, `password_hash`, `role` (`user`, `editor`, `admin`),
   `created_at` и `register_ip`.  Этот набор уже используется в Shorty и легко
   расширяется для Katindirnet.
2. **Настройки сайта**.  Глобальные параметры хранятся в таблице `settings`.
   Пример: `site_name`, `site_favicon`, `copyright`, `theme`.  Это позволяет
   администратору менять название проекта, иконку и внешний вид без
   редактирования кода.
3. **Домены и ссылки**.  Таблицы `domains`, `links` и `hits` из Shorty
   переносятся без изменений: они обеспечивают хранение доменов, сокращённых
   ссылок и логи переходов.
4. **Контент Katindirnet**.  Данные, которые раньше хранились в `localStorage`
   (дополнительные фото, карусель друзей, подписи, галерея мемов и т. д.),
   переносятся в структурированные таблицы.
5. **Связи и внешние ключи**.  Во всех таблицах используются внешние ключи
   (FOREIGN KEY) для обеспечения целостности: например, ссылки принадлежат
   пользователям (`links.user_id` → `users.id`), фотографии в галерее
   принадлежат пользователю (`gallery_images.user_id`), и так далее.

## Таблицы

### `users`

| Поле         | Тип          | Назначение                                             |
|--------------|-------------|---------------------------------------------------------|
| id           | INTEGER PK  | Уникальный идентификатор пользователя                   |
| email        | TEXT UNIQUE | Логин пользователя (email или ник)                      |
| password_hash| TEXT        | Хэш пароля (используется `password_hash`/`verify`)      |
| role         | TEXT        | Роль (`user`, `editor`, `admin`)                        |
| created_at   | TEXT        | Дата и время регистрации (ISO8601)                     |
| register_ip  | TEXT        | IP‑адрес при регистрации                                |

### `settings`

| Поле | Тип   | Назначение                           |
|------|-------|-------------------------------------|
| key  | TEXT PK | Название параметра (например `site_name`) |
| value| TEXT  | Значение параметра                   |

### `domains`

| Поле       | Тип         | Назначение                                     |
|------------|------------|-----------------------------------------------|
| id         | INTEGER PK | Идентификатор домена                          |
| host       | TEXT UNIQUE| Доменное имя (например `s.example.com`)       |
| is_active  | INTEGER    | 1 — активен, 0 — выключен                     |
| created_at | TEXT       | Дата добавления                               |

### `links`

| Поле       | Тип          | Назначение                                                      |
|------------|-------------|----------------------------------------------------------------|
| id         | INTEGER PK  | Идентификатор короткой ссылки                                   |
| user_id    | INTEGER     | Владелец (FK → users.id)                                        |
| domain_id  | INTEGER     | Домен (FK → domains.id)                                         |
| slug       | TEXT UNIQUE | Человеко‑читаемый “линк”                                        |
| target     | TEXT        | Полный URL назначения                                           |
| created_at | TEXT        | Когда создана                                                   |
| hits       | INTEGER     | Счётчик переходов                                              |
| last_hit   | TEXT        | Когда последний раз переходили                                  |
| creator_ip | TEXT        | IP при создании                                                 |

### `hits`

| Поле        | Тип         | Назначение                                        |
|-------------|------------|--------------------------------------------------|
| id          | INTEGER PK | Идентификатор перехода                           |
| link_id     | INTEGER    | FK → links.id                                    |
| created_at  | TEXT       | Дата/время перехода                              |
| ip          | TEXT       | IP посетителя                                    |
| user_agent  | TEXT       | User‑Agent посетителя                            |
| referer     | TEXT       | Откуда пришли                                   |
| accept_lang | TEXT       | Языковые предпочтения                            |

### `profiles`

Хранит профили персонажей (Катя, Индира и др.) и “BIO” каждого участника.

| Поле      | Тип         | Назначение                                       |
|-----------|------------|-------------------------------------------------|
| id        | INTEGER PK | Идентификатор профиля                           |
| user_id   | INTEGER    | Кто создал/владеет (FK → users.id)              |
| name      | TEXT       | Имя персонажа                                   |
| about     | TEXT       | Краткое описание (“BIO”)                        |
| role      | TEXT       | Должность или описание роли                     |
| avatar    | TEXT       | Путь к фото (загруженное изображение)          |
| created_at| TEXT       | Дата добавления                                |

### `carousel_entries`

Содержит карточки друзей для карусели.

| Поле      | Тип         | Назначение                                      |
|-----------|------------|------------------------------------------------|
| id        | INTEGER PK | Идентификатор карточки                        |
| user_id   | INTEGER    | FK → users.id                                 |
| name      | TEXT       | Имя                                            |
| role      | TEXT       | Роль (например «Инфлюенсер улыбок»)          |
| medal     | TEXT       | Медаль/отличие                                |
| image     | TEXT       | Путь к фото                                   |
| created_at| TEXT       | Дата добавления                               |

### `gallery_images`

Дополнительные фотографии, которые пользователь добавляет на главной странице.

| Поле      | Тип         | Назначение                                       |
|-----------|------------|-------------------------------------------------|
| id        | INTEGER PK | Идентификатор изображения                       |
| user_id   | INTEGER    | FK → users.id                                   |
| image     | TEXT       | Путь к загруженному файлу                       |
| created_at| TEXT       | Дата загрузки                                  |

### `captions`

Подписи для совместного фото (“мем‑баннер”).  Ранее подпись хранилась в
localStorage; в новой архитектуре каждая подпись хранится в базе.

| Поле      | Тип         | Назначение                                      |
|-----------|------------|------------------------------------------------|
| id        | INTEGER PK | Идентификатор подписи                         |
| user_id   | INTEGER    | FK → users.id                                 |
| text      | TEXT       | Текст подписи                                 |
| created_at| TEXT       | Дата создания                                 |

### Другие таблицы

- **`themes`** — список тем и настроек интерфейса (необязательно, можно
  хранить в `settings`)
- **`tickers`** — если требуется хранить данные для бегущей строки, можно
  вынести её содержимое из JS в базу
- **`quotes`** — аналогично, цитаты для секции “Цитаты” можно хранить в БД,
  чтобы администратор мог редактировать их через интерфейс.

## Схема миграции от localStorage

Существующие данные Katindirnet хранятся в браузере (LocalStorage) и
сбрасываются при очистке кэша.  Для перехода на SQLite требуется:

1. Создать таблицы из этого плана в единой базе (например, `database.db`).
2. Реализовать API‑обработчики на PHP для чтения, создания, обновления и
   удаления данных (gallery, carousel, captions, profiles).  Эти
   обработчики будут вызываться из JavaScript через `fetch` вместо
   непосредственного чтения/записи localStorage.
3. Модифицировать существующие скрипты (`js/index.js` и другие) так, чтобы
   они отправляли AJAX‑запросы к серверным эндпоинтам (например
   `/api/gallery.php`, `/api/carousel.php`), а не использовали LS.
4. Обновить HTML: добавить формы для загрузки файлов, изменить
   пути изображений на серверные (например, `/uploads/filename.png`).
5. Перенести CV‑генератор (`cv.php`) в общую систему пользователей
   (если требуется), чтобы сохранять созданные резюме в БД.

## Интеграция инструмента Shorty

Сервис сокращения ссылок Shorty интегрируется в раздел “Инструменты” на
главной странице Katindirnet.  В `index.php` добавлена ссылка:

```html
<a href="/shorty/index.php" class="tool-link">
  <span class="tool-logo">🔗</span>
  <span class="sep" aria-hidden="true"></span>
  <span class="tool-desc">Shorty</span>
</a>
```

Shorty использует таблицы `users`, `domains`, `links`, `hits` и
`settings` из общей базы данных.  Разграничение прав (пользователь,
редактор, администратор) выполняется через поле `role` в таблице
`users`.

## Заключение

Предложенная схема позволяет постепенно перевести Katindirnet на
серверное хранение с использованием SQLite, при этом не нарушая
существующий интерфейс и дизайн.  Она также объединяет Shorty и
Katindirnet в единую экосистему с общими пользователями, ролями и
настройками.  В дальнейшем можно добавить админ‑интерфейс для
управления профилями, каруселью, галереей и новыми инструментами.